<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form FAQ - WOM Finance</title>
    <link rel="icon" href="wom-finance.jpg" type="image/png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container-fluid py-3">
      <h1 class="mb-4 text-center">Isi Form FAQ - WOM Finance</h1>
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0 small">Isi Form FAQ</h5>
        </div>
        <div class="card-body">
          <form id="faqForm" method="POST" enctype="multipart/form-data" action="AKfycby7EzS_v8XLMsNwtzSXi-GLu4RZl1j1Vln4jJH4TqwXMrQbJupAo2bK-1KRTHBjh-d3AA">
            <div class="row mb-2">
              <div class="col-md-6">
                <label for="brand" class="form-label small text-muted"
                  >Brand</label
                >
                <select id="brand" class="form-select form-select-sm" required>
                  <option value="">-- Pilih Brand --</option>
                  <option value="nb">Reguler</option>
                  <option value="mas">MasKu</option>
                  <option value="mtr">MotorKu</option>
                  <option value="mbl">MobilKu</option>
                </select>
                <div class="invalid-feedback">Brand harus dipilih!</div>
              </div>
              <div class="col-md-6">
                <label for="errorSystem" class="form-label small text-muted"
                  >Error Sistem</label
                >
                <select
                  id="errorSystem"
                  name="entry.900671353"
                  class="form-select form-select-sm"
                >
                  <option value="">-- Pilih Error Sistem --</option>
                  <option value="ki">KI</option>
                  <option value="mss">MSS</option>
                  <option value="wise">WISE</option>
                  <option value="login">Login</option>
                </select>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <label for="region" class="form-label small text-muted"
                  >Region</label
                >
                <select
                  id="region"
                  name="entry.453750574"
                  class="form-select form-select-sm"
                >
                  <option value="">-- Pilih Region --</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="cabang" class="form-label small text-muted"
                  >Cabang</label
                >
                <select
                  id="cabang"
                  name="entry.27483305"
                  class="form-select form-select-sm"
                >
                  <option value="">-- Pilih Cabang --</option>
                </select>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <label for="NCust" class="form-label small text-muted"
                  >Nama Cust</label
                >
                <input
                  type="text"
                  id="NCust"
                  name="entry.349701399"
                  class="form-control form-control-sm"
                />
              </div>
              <div class="col-md-6">
                <label for="IdCust" class="form-label small text-muted"
                  >Cust ID</label
                >
                <input
                  type="text"
                  id="IdCust"
                  name="entry.1285711467"
                  class="form-control form-control-sm"
                />
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <label for="pic" class="form-label small text-muted"
                  >PIC Input</label
                >
                <input
                  type="text"
                  id="pic"
                  name="entry.1383050238"
                  class="form-control form-control-sm"
                  required
                />
                <div class="invalid-feedback">PIC harus diisi!</div>
              </div>
              <div class="col-md-6">
                <label for="NoKwn" class="form-label small text-muted"
                  >No Kawan Internal</label
                >
                <input
                  type="text"
                  id="NoKwn"
                  name="entry.1372652565"
                  class="form-control form-control-sm"
                  required
                />
                <div class="invalid-feedback">No Kawan harus diisi!</div>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <label for="IdPolo" class="form-label small text-muted"
                  >Task ID Polo</label
                >
                <input
                  type="text"
                  id="IdPolo"
                  name="entry.163739172"
                  class="form-control form-control-sm"
                />
                <div class="invalid-feedback">Task ID Polo harus diisi!</div>
              </div>
              <div class="col-md-6">
                <label for="NoApp" class="form-label small text-muted"
                  >No APP</label
                >
                <input
                  type="text"
                  id="NoApp"
                  name="entry.66506618"
                  class="form-control form-control-sm"
                />
                <div class="invalid-feedback">No APP harus diisi!</div>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <label for="NoOdrn" class="form-label small text-muted"
                  >No Odrn</label
                >
                <input
                  type="text"
                  id="NoOdrn"
                  name="entry.996527903"
                  class="form-control form-control-sm"
                />
                <div class="invalid-feedback">No Odrn harus diisi!</div>
              </div>
              <div class="col-md-6">
                <label for="fileUpload" class="form-label small text-muted"
                  >Upload Foto/Video</label
                >
                <input
                  type="file"
                  id="fileUpload"
                  name="fileUpload"
                  class="form-control form-control-sm"
                  accept="image/*,video/*"
                  multiple
                />
                <div class="form-text small text-muted">
                  Max file size: 10MB. Accepted formats: images (jpg, png, gif),
                  videos (mp4, mov).
                </div>
                <div id="uploadProgress" class="progress mt-2 d-none">
                  <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="uploadedFiles" class="mt-2"></div>
              </div>
            </div>

            <div class="mb-2">
              <label for="issue" class="form-label small text-muted"
                >Issue</label
              >
              <textarea
                id="issue"
                name="entry.902491819"
                class="form-control form-control-sm"
                rows="5"
                required
              ></textarea>
              <div class="invalid-feedback">Issue harus diisi!</div>
            </div>

            <div class="mb-2">
              <button
                type="submit"
                id="submitButton"
                class="btn btn-primary btn-sm"
              >
                Submit
              </button>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                onclick="window.location.reload()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
document.getElementById("faqForm").addEventListener("submit", function(e) {
  e.preventDefault();
  var formData = new FormData(this);

  fetch("AKfycby7EzS_v8XLMsNwtzSXi-GLu4RZl1j1Vln4jJH4TqwXMrQbJupAo2bK-1KRTHBjh-d3AA", {
    method: "POST",
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.status == "success") {
      Swal.fire({
        title: "Upload Berhasil!",
        html: "File Anda telah di-upload.<br>Link folder: <a href='" + data.folderUrl + "' target='_blank'>" + data.folderUrl + "</a>",
        icon: "success"
      });
    } else {
      Swal.fire("Gagal", "Terjadi error saat upload", "error");
    }
  });
});
      
</script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.all.min.js"></script>
    <script>
      // Ambil data dari file region.json dan isi dropdown
      // Fungsi untuk memuat dropdown Region dan Cabang
      function loadRegionData() {
        fetch("region.json") // Pastikan path JSON sesuai dengan lokasi file Anda
          .then((response) => response.json())
          .then((data) => {
            // Dapatkan elemen select untuk region dan cabang
            const regionSelect = document.getElementById("region");
            const cabangSelect = document.getElementById("cabang");

            // Clear existing options
            regionSelect.innerHTML =
              '<option value="">-- Pilih Region --</option>';
            cabangSelect.innerHTML =
              '<option value="">-- Pilih Cabang --</option>';

            // Menambahkan option untuk region
            const regions = [...new Set(data.map((item) => item.REGION_NAME))]; // Mengambil region yang unik
            regions.forEach((region) => {
              const option = document.createElement("option");
              option.value = region;
              option.textContent = region;
              regionSelect.appendChild(option);
            });

            // Menambahkan event listener untuk mengubah cabang saat region dipilih
            regionSelect.addEventListener("change", function () {
              const selectedRegion = regionSelect.value;
              if (selectedRegion) {
                // Menampilkan cabang berdasarkan region yang dipilih
                const filteredCabangs = data.filter(
                  (item) => item.REGION_NAME === selectedRegion
                );
                cabangSelect.innerHTML =
                  '<option value="">-- Pilih Cabang --</option>'; // Clear existing options
                filteredCabangs.forEach((item) => {
                  const option = document.createElement("option");
                  option.value = item.COMP_OFFICE_NAME;
                  option.textContent = item.COMP_OFFICE_NAME;
                  cabangSelect.appendChild(option);
                });
              }
            });
          })
          .catch((error) => {
            console.error("Error fetching region data:", error);
          });
      }

      // Fungsi untuk validasi dan set required fields
      function updateRequiredFields(errorSystem) {
        // Hapus tanda '*' dari semua label sebelum menambahkan yang baru
        const labels = document.querySelectorAll("label");
        labels.forEach((label) => {
          const star = label.querySelector(".text-danger");
          if (star) {
            star.remove();
          }
        });

        // Menambahkan tanda '*' sesuai dengan pilihan errorSystem
        if (errorSystem === "ki") {
          document.querySelector('label[for="region"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="cabang"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="brand"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="NCust"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="pic"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="NoKwn"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="issue"]').innerHTML +=
            ' <span class="text-danger">*</span>';
        } else if (errorSystem === "mss" || errorSystem === "wise") {
          document.querySelector('label[for="region"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="cabang"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="NCust"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="pic"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="NoKwn"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="issue"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="IdPolo"]').innerHTML +=
            ' <span class="text-danger">*</span>';
        } else if (errorSystem === "login") {
          document.querySelector('label[for="region"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="cabang"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="pic"]').innerHTML +=
            ' <span class="text-danger">*</span>';
          document.querySelector('label[for="issue"]').innerHTML +=
            ' <span class="text-danger">*</span>';
        }
      }

      // Event listener untuk validasi saat form disubmit
      document
        .getElementById("faqForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Ambil nilai field dari form
          const errorSystem = document.getElementById("errorSystem").value;
          const region = document.getElementById("region").value;
          const cabang = document.getElementById("cabang").value;
          const NCust = document.getElementById("NCust").value;
          const pic = document.getElementById("pic").value;
          const NoKwn = document.getElementById("NoKwn").value;
          const issue = document.getElementById("issue").value;
          const IdPolo = document.getElementById("IdPolo").value;
          const fileUpload = document.getElementById("fileUpload").files; // Get the selected files

          // Validasi berdasarkan error system
          let valid = true;
          let message = "";

          if (errorSystem === "ki") {
            if (!region || !cabang || !NCust || !pic || !NoKwn || !issue) {
              valid = false;
              message =
                "Harap lengkapi semua field yang wajib diisi untuk Error Sistem KI!";
            }
          } else if (errorSystem === "mss" || errorSystem === "wise") {
            if (
              !region ||
              !cabang ||
              !NCust ||
              !pic ||
              !NoKwn ||
              !issue ||
              !IdPolo
            ) {
              valid = false;
              message =
                "Harap lengkapi semua field yang wajib diisi untuk Error Sistem MSS/WISE!";
            }
          } else if (errorSystem === "login") {
            if (!region || !cabang || !pic || !issue) {
              valid = false;
              message =
                "Harap lengkapi semua field yang wajib diisi untuk Error Sistem Login!";
            }
          } else {
            valid = false;
            message = "Pilih Error Sistem yang valid!";
          }

          if (!valid) {
            Swal.fire("Error", message, "error");
          } else {
            // Tentukan link Google Form berdasarkan Brand
            let googleFormLink = "";
            const brand = document.getElementById("brand").value;

            if (brand === "nb") {
              googleFormLink =
                "https://docs.google.com/forms/d/e/1FAIpQLSd4QnQuXr5LnkGxuUAFz42uF8J5VcjsDgmoRKKEe_iklgjKOQ/viewform?usp=header";
            } else if (brand === "mas") {
              googleFormLink =
                "https://docs.google.com/forms/d/e/1FAIpQLSfEXipvuQMO5xS88d2xAchfcnR2V0yhlbu0USi1VnoyRdw4Lw/viewform?usp=header";
            } else if (brand === "mtr") {
              googleFormLink =
                "https://docs.google.com/forms/d/e/1FAIpQLSeA9x14ryubOILKWxeUGkZPWvu8fqySXNgG93OHKDe4wRmQxw/viewform?usp=header";
            } else if (brand === "mbl") {
              googleFormLink =
                "https://docs.google.com/forms/d/e/1FAIpQLScq0e9xsRcZKe32cuYLAziQ2e2NqSTvbqY7swjCrjxN6eKUjg/viewform?usp=header";
            } else {
              valid = false;
              message = "Pilih brand yang valid!";
            }

            if (valid) {
              const form = document.getElementById("faqForm");
              form.action = googleFormLink;
              form.method = "POST";

              // Check if files are selected and handle them
              if (fileUpload.length > 0) {
                // IMPORTANT: Directly uploading files to Google Forms via a simple POST request
                // from an external HTML form is NOT straightforward. Google Forms usually handles
                // file uploads through its own UI and stores them in Google Drive.
                //
                // To truly integrate file uploads, you would typically need a backend server
                // to handle the file upload, store it (e.g., in Google Drive via Google Drive API),
                // and then submit the file's URL to your Google Form.
                //
                // For a simple client-side HTML form submitting to Google Forms,
                // the file input will likely NOT work as expected for direct upload.
                //
                // As a workaround for this client-side form, you could:
                // 1. Instruct users to upload files manually to a shared folder and paste the link.
                // 2. Consider using a different form submission method if file upload is critical.
                //
                // For this example, we'll proceed with submitting the form, but be aware
                // that the `fileUpload` field will not be directly processed by Google Forms
                // if it's expecting a file upload through its native mechanism.
                //
                // If you *must* have file uploads, you'd generally need to:
                // a. Use Google Apps Script to create a web app that receives the file,
                //    uploads it to Drive, and then submits the form.
                // b. Use a backend server to handle the upload and Google Drive API.

                // For a basic setup, you might consider appending the file names or a placeholder
                // if direct upload isn't feasible with your current Google Form setup.
                // However, without a backend, the actual file data won't go to Google Forms.

                // If your Google Form has a "File Upload" question, you need to find its
                // `entry.XXXXXXXXXX` ID and typically, the form would expect a Google Drive URL
                // in that field, not the file itself.

                // For demonstration, we'll just submit the form. The `fileUpload` input
                // has the correct `name` attribute that you would get from inspecting
                // the Google Form's file upload question.
              }

              form.submit();

              // After successful submission, generate and display a ticket number
              // This is a client-side generated number and NOT from Google Forms itself.
              setTimeout(function () {
                const success = true; // Assume success after form.submit() for this example

                if (success) {
                  // Generate a simple ticket number (e.g., timestamp-based)
                  const ticketNumber = "WOM-" + Date.now().toString().slice(-8); // Example: WOM-last 8 digits of timestamp

                  Swal.fire({
                    title: "Berhasil!",
                    html: `Formulir berhasil dikirim.<br>Nomor Tiket Anda: <strong>${ticketNumber}</strong>`, // Added strong tag for emphasis
                    icon: "success",
                  }).then(() => {
                    // Optional: Reset the form after success
                    form.reset();
                    // Remove validation styles
                    form.classList.remove("was-validated");
                    // Reload region data to reset dropdowns
                    loadRegionData();
                    // Clear required field indicators
                    updateRequiredFields("");
                  });
                } else {
                  Swal.fire("Gagal!", "Pengiriman formulir gagal.", "error");
                }
              }, 2000); // Wait for 2 seconds to simulate submission
            }
          }
        });

      // Load region data saat halaman dimuat
      document.addEventListener("DOMContentLoaded", function () {
        loadRegionData();
      });
      // Event listener untuk dropdown error system
      document
        .getElementById("errorSystem")
        .addEventListener("change", function () {
          const errorSystem = this.value;
          updateRequiredFields(errorSystem); // Panggil fungsi dengan parameter yang sesuai
        });

      // Add this new code for file upload handling
      document.getElementById("fileUpload").addEventListener("change", async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        const uploadProgress = document.getElementById("uploadProgress");
        const progressBar = uploadProgress.querySelector(".progress-bar");
        const uploadedFiles = document.getElementById("uploadedFiles");
        const brand = document.getElementById("brand").value;
        
        if (!brand) {
          Swal.fire("Error", "Pilih brand terlebih dahulu!", "error");
          this.value = ""; // Clear file input
          return;
        }
        
        uploadProgress.classList.remove("d-none");
        uploadedFiles.innerHTML = "";

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("file", file);
          formData.append("fileName", file.name);
          formData.append("fileType", file.type);
          formData.append("brand", brand);

          try {
            const response = await fetch("AKfycby7EzS_v8XLMsNwtzSXi-GLu4RZl1j1Vln4jJH4TqwXMrQbJupAo2bK-1KRTHBjh-d3AA", {
              method: "POST",
              body: formData
            });

            const result = await response.json();
            
            if (result.status === "success") {
              // Add file link to the uploaded files list
              const fileLink = document.createElement("div");
              fileLink.className = "small text-muted";
              fileLink.innerHTML = `<a href="${result.fileUrl}" target="_blank">${file.name}</a>`;
              uploadedFiles.appendChild(fileLink);

              // Add hidden input with file URL and brand
              const hiddenInput = document.createElement("input");
              hiddenInput.type = "hidden";
              hiddenInput.name = "fileUrls[]";
              hiddenInput.value = JSON.stringify({
                url: result.fileUrl,
                brand: brand,
                spreadsheetUrl: result.spreadsheetUrl
              });
              document.getElementById("faqForm").appendChild(hiddenInput);
            }

            // Update progress
            const progress = ((i + 1) / files.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute("aria-valuenow", progress);
          } catch (error) {
            console.error("Error uploading file:", error);
            Swal.fire("Error", "Gagal mengupload file: " + file.name, "error");
          }
        }

        // Hide progress bar after all uploads complete
        setTimeout(() => {
          uploadProgress.classList.add("d-none");
        }, 1000);
      });

      // Modify the form submission to include file URLs and brand information
      document.getElementById("faqForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        // Get all file URLs with their brand information
        const fileData = Array.from(document.querySelectorAll('input[name="fileUrls[]"]')).map(input => JSON.parse(input.value));
        
        // Add file data to form data
        const formData = new FormData(this);
        formData.append("fileData", JSON.stringify(fileData));

        // Show loading
        showLoading("Mengirim form...");

        fetch("AKfycby7EzS_v8XLMsNwtzSXi-GLu4RZl1j1Vln4jJH4TqwXMrQbJupAo2bK-1KRTHBjh-d3AA", {
          method: "POST",
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          hideLoading();
          if (data.status === "success") {
            let message = `Formulir berhasil dikirim.<br>Nomor Tiket: <strong>${data.ticketNumber}</strong><br>`;
            
            // Add links to brand-specific spreadsheets
            if (data.spreadsheetLinks) {
              message += "<br>Link Spreadsheet:<br>";
              Object.entries(data.spreadsheetLinks).forEach(([brand, url]) => {
                message += `<a href="${url}" target="_blank">${brand}</a><br>`;
              });
            }
            
            Swal.fire({
              title: "Berhasil!",
              html: message,
              icon: "success"
            }).then(() => {
              this.reset();
              document.getElementById("uploadedFiles").innerHTML = "";
              loadRegionData();
              updateRequiredFields("");
            });
          } else {
            Swal.fire("Gagal", "Terjadi error saat mengirim form", "error");
          }
        })
        .catch(error => {
          hideLoading();
          console.error("Error:", error);
          Swal.fire("Error", "Terjadi kesalahan saat mengirim form", "error");
        });
      });
    </script>
  </body>
</html>
